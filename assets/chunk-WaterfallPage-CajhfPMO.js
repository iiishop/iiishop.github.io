const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunk-SteamGameBlock-BHCivTlN.js","assets/entry-index-D8c4lH7g.js","assets/chunk-mermaid-lib--N4Maba6.js","assets/asset-index-whA3utIM.css","assets/chunk-color-thief-DF3QbzqH.js","assets/chunk-_plugin-vue_export-helper-DlAUqK2U.js","assets/asset-SteamGameBlock-B-ltQF1U.css","assets/chunk-BangumiBlock-ClDs8JIp.js","assets/asset-BangumiBlock-CZgwujlY.css","assets/chunk-BilibiliVideoBlock-Ci2G_TiQ.js","assets/asset-BilibiliVideoBlock-DE3SKqHY.css","assets/chunk-GithubRepoBlock-D5JFKsd7.js","assets/asset-GithubRepoBlock-CkND9FTr.css","assets/chunk-XiaohongshuNoteBlock-QA0pO13u.js","assets/asset-XiaohongshuNoteBlock-C8nWHP7E.css"])))=>i.map(i=>d[i]);
import{an as me,_ as S}from"./chunk-mermaid-lib--N4Maba6.js";import ye from"./chunk-BaseLayout-yo_Qpryy.js";import be from"./chunk-WaterfallPanel-DoE47T7h.js";import{r as m,i as R,v as ie,f as fe,j as we,c as ge,o as w,b as C,l as A,e,a as oe,m as ke,t as b,y as ce,w as ve,T as xe,A as Me,E as _e,H as Ie,n as ae,d as X,F as Pe}from"./entry-index-D8c4lH7g.js";import{m as he}from"./chunk-MarkdownRenender-CYXJ7tNL.js";import{r as Ce}from"./chunk-DynamicComponentRenderer-Db7kQm2w.js";import We from"./chunk-UtterancesComments-AThzYdu-.js";import{_ as pe}from"./chunk-_plugin-vue_export-helper-DlAUqK2U.js";import{f as De}from"./chunk-index-NHvVYUgd.js";import"./chunk-index-D-nlVayj.js";const Ee={class:"modal-image-section"},Le=["src","alt"],Te={class:"image-info-float"},Be={class:"image-dimensions"},Re={class:"image-format"},Se={class:"image-zoom"},$e={class:"image-toolbar"},Fe={class:"toolbar-group"},Oe={class:"zoom-text"},Ae={class:"toolbar-group"},He={key:0,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Ne={key:1,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},Ve={key:0,class:"image-info-panel"},Ge={class:"info-item"},je={class:"info-value"},Ue={class:"info-item"},Xe={class:"info-value"},ze={class:"info-item"},Ye={class:"info-value"},qe={class:"info-item"},Ke={class:"info-value"},Qe={class:"info-item"},Ze={class:"info-value"},Je={class:"info-item"},et={class:"info-value"},tt={key:0,class:"modal-description-section"},at=["innerHTML"],ot={class:"comments-section"},nt={__name:"ImageModal",props:{image:{type:Object,required:!0},description:{type:String,default:""},triggerCardRect:{type:Object,default:null},images:{type:Array,default:()=>[]},currentIndex:{type:Number,default:0}},emits:["close","next","prev"],setup(x,{emit:$}){const H=X(()=>S(()=>import("./chunk-SteamGameBlock-BHCivTlN.js"),__vite__mapDeps([0,1,2,3,4,5,6]))),F=X(()=>S(()=>import("./chunk-BangumiBlock-ClDs8JIp.js"),__vite__mapDeps([7,1,2,3,4,5,8]))),M=X(()=>S(()=>import("./chunk-BilibiliVideoBlock-Ci2G_TiQ.js"),__vite__mapDeps([9,1,2,3,5,10]))),z=X(()=>S(()=>import("./chunk-GithubRepoBlock-D5JFKsd7.js"),__vite__mapDeps([11,1,2,3,5,12]))),N=X(()=>S(()=>import("./chunk-XiaohongshuNoteBlock-QA0pO13u.js"),__vite__mapDeps([13,1,2,3,5,14]))),c=x,V=$,G=m(null),Y=m(null),W=m(!1),p=m(""),f=m(1),D=m(0),E=m(0),L=m(0),_=m(!1),q=m(0),K=m(0),I=m(!1),O=m(!1),o=R(()=>c.image.width&&c.image.height?`${c.image.width} × ${c.image.height}`:""),n=R(()=>c.image.src?c.image.src.split(".").pop().toUpperCase():""),l=R(()=>({transform:`scale(${f.value}) rotate(${D.value}deg) translate(${E.value}px, ${L.value}px)`,cursor:f.value>1?_.value?"grabbing":"grab":"default",transition:_.value?"none":"transform 0.3s ease"})),a=R(()=>c.images&&c.images.length>1&&c.currentIndex>0),s=R(()=>c.images&&c.images.length>1&&c.currentIndex<c.images.length-1),i=R(()=>{const r=p.value||c.description;if(!r)return"";const t=r.trim().toLowerCase();if(t.startsWith("<!doctype")||t.startsWith("<html")||t.includes("<!doctype html>"))return console.warn("[ImageModal] Blocked HTML content from rendering"),"";let d=r;if(d.startsWith("---")){const h=d.indexOf("---",3);h!==-1&&(d=d.substring(h+3).trim())}return he.render(d)}),u=R(()=>{const r=p.value||c.description;if(!r)return!1;const t=r.trim().toLowerCase();return!(t.startsWith("<!doctype")||t.startsWith("<html")||t.includes("<!doctype html>"))});async function v(){if(!c.image.mdPath){p.value="";return}try{const r=await fetch(c.image.mdPath);if(!r.ok){console.log("[ImageModal] .md file not found (status:",r.status,")"),p.value="";return}if((r.headers.get("content-type")||"").includes("text/html")){console.log("[ImageModal] .md file not found (got HTML content-type)"),p.value="";return}const d=await r.text();if(!d||!d.trim()){console.log("[ImageModal] .md file is empty"),p.value="";return}const h=d.trim().toLowerCase();if(h.startsWith("<!doctype")||h.startsWith("<html")||h.includes("<!doctype html>")||h.includes("<html>")){console.log("[ImageModal] .md file not found (got HTML page)"),p.value="";return}p.value=d,console.log("[ImageModal] Successfully loaded .md file")}catch(r){console.log("[ImageModal] Failed to load markdown description:",r),p.value=""}}function g(){W.value=!1,T(),V("close")}function T(){f.value=1,D.value=0,E.value=0,L.value=0,_.value=!1}function j(){f.value=Math.min(f.value+.25,5)}function y(){f.value=Math.max(f.value-.25,.5)}function k(){f.value=1,E.value=0,L.value=0}function Q(){D.value-=90}function Z(){D.value+=90}async function B(){try{const t=await(await fetch(c.image.src)).blob(),d=window.URL.createObjectURL(t),h=document.createElement("a");h.href=d,h.download=c.image.title||"image",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(d)}catch(r){console.error("[ImageModal] Failed to download image:",r),alert("下载失败，请稍后重试")}}async function ne(){try{const r=window.location.origin+c.image.src;await navigator.clipboard.writeText(r),alert("✓ 图片链接已复制到剪贴板")}catch(r){console.error("[ImageModal] Failed to copy link:",r),alert("复制失败，请手动复制")}}function J(){I.value=!I.value}function ee(){O.value=!O.value}function U(r){f.value<=1||(_.value=!0,q.value=r.clientX-E.value,K.value=r.clientY-L.value,r.preventDefault())}function P(r){_.value&&(E.value=r.clientX-q.value,L.value=r.clientY-K.value)}function te(){_.value=!1}function le(){f.value===1?f.value=2:k()}function se(r){r.preventDefault();const t=r.deltaY>0?-.1:.1;f.value=Math.max(.5,Math.min(5,f.value+t))}function re(){a.value&&(T(),V("prev"))}function de(){s.value&&(T(),V("next"))}function ue(r){if(W.value)switch(r.key){case"Escape":g();break;case"ArrowLeft":re();break;case"ArrowRight":de();break;case"+":case"=":j();break;case"-":case"_":y();break;case"0":k();break;case"f":case"F":J();break;case"i":case"I":ee();break;case"d":case"D":B();break}}return ie(()=>c.image,r=>{r&&(W.value=!0,T(),v())},{immediate:!0}),ie(W,r=>{r&&ae(()=>{G.value&&G.value.focus()})}),ie(i,async()=>{await ae();const r=Y.value;if(r&&(Ce(r,{bilibilivideoblock:M,steamgameblock:H,bangumiblock:F,githubrepoblock:z,xiaohongshunoteblock:N}),await ae(),typeof me<"u"))try{await me.run({nodes:r.querySelectorAll(".mermaid")}),await ae(),r.querySelectorAll(".mermaid svg").forEach(d=>{d.removeAttribute("width"),d.removeAttribute("height"),d.style.width="100%",d.style.height="400px",d.style.maxWidth="100%",d.style.maxHeight="400px",d.style.display="block",d.style.margin="0 auto"})}catch(t){console.warn("[ImageModal] Mermaid rendering failed:",t)}}),fe(()=>{document.addEventListener("keydown",ue),v()}),we(()=>{document.removeEventListener("keydown",ue)}),(r,t)=>(w(),ge(Ie,{to:"body"},[W.value?(w(),C("div",{key:0,class:"image-modal",onClick:_e(g,["self"]),onKeydown:Me(g,["esc"]),tabindex:"0",ref_key:"modalRef",ref:G},[t[20]||(t[20]=e("div",{class:"modal-backdrop"},null,-1)),e("div",{class:ce(["modal-content",{"no-description":!u.value,"fullscreen-mode":I.value}])},[e("div",Ee,[e("div",{class:"image-container",onWheel:se},[e("img",{src:x.image.src,alt:x.image.alt,class:"modal-image",style:ke(l.value),onMousedown:U,onMousemove:P,onMouseup:te,onMouseleave:te,onDblclick:le},null,44,Le),e("div",Te,[e("span",Be,b(o.value),1),e("span",Re,b(n.value),1),e("span",Se,b(Math.round(f.value*100))+"%",1)])],32),e("div",$e,[e("div",Fe,[e("button",{class:"toolbar-btn",onClick:y,title:"缩小 (-)"},t[0]||(t[0]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("circle",{cx:"11",cy:"11",r:"8"}),e("path",{d:"M8 11h6"}),e("path",{d:"M21 21l-4.35-4.35"})],-1)])),e("button",{class:"toolbar-btn",onClick:k,title:"重置 (0)"},[e("span",Oe,b(Math.round(f.value*100))+"%",1)]),e("button",{class:"toolbar-btn",onClick:j,title:"放大 (+)"},t[1]||(t[1]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("circle",{cx:"11",cy:"11",r:"8"}),e("path",{d:"M11 8v6M8 11h6"}),e("path",{d:"M21 21l-4.35-4.35"})],-1)]))]),e("div",{class:"toolbar-group"},[e("button",{class:"toolbar-btn",onClick:Q,title:"逆时针旋转"},t[2]||(t[2]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"}),e("path",{d:"M3 3v5h5"})],-1)])),e("button",{class:"toolbar-btn",onClick:Z,title:"顺时针旋转"},t[3]||(t[3]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"}),e("path",{d:"M21 3v5h-5"})],-1)]))]),e("div",Ae,[e("button",{class:"toolbar-btn",onClick:B,title:"下载图片 (D)"},t[4]||(t[4]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e("polyline",{points:"7 10 12 15 17 10"}),e("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1)])),e("button",{class:"toolbar-btn",onClick:ne,title:"复制链接"},t[5]||(t[5]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"}),e("path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"})],-1)])),e("button",{class:ce(["toolbar-btn",{active:O.value}]),onClick:ee,title:"图片信息 (I)"},t[6]||(t[6]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("circle",{cx:"12",cy:"12",r:"10"}),e("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})],-1)]),2),e("button",{class:ce(["toolbar-btn",{active:I.value}]),onClick:J,title:"图片全屏 (F)"},[I.value?(w(),C("svg",Ne,t[8]||(t[8]=[e("path",{d:"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"},null,-1)]))):(w(),C("svg",He,t[7]||(t[7]=[e("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"},null,-1)])))],2)])]),oe(xe,{name:"info-panel-fade"},{default:ve(()=>[O.value?(w(),C("div",Ve,[t[15]||(t[15]=e("h3",null,"图片信息",-1)),e("div",Ge,[t[9]||(t[9]=e("span",{class:"info-label"},"标题:",-1)),e("span",je,b(x.image.title||"无"),1)]),e("div",Ue,[t[10]||(t[10]=e("span",{class:"info-label"},"编辑日期:",-1)),e("span",Xe,b(x.image.date||"无"),1)]),e("div",ze,[t[11]||(t[11]=e("span",{class:"info-label"},"尺寸:",-1)),e("span",Ye,b(o.value||"未知"),1)]),e("div",qe,[t[12]||(t[12]=e("span",{class:"info-label"},"格式:",-1)),e("span",Ke,b(n.value),1)]),e("div",Qe,[t[13]||(t[13]=e("span",{class:"info-label"},"缩放:",-1)),e("span",Ze,b(Math.round(f.value*100))+"%",1)]),e("div",Je,[t[14]||(t[14]=e("span",{class:"info-label"},"旋转:",-1)),e("span",et,b(D.value)+"°",1)])])):A("",!0)]),_:1}),a.value?(w(),C("button",{key:0,class:"nav-btn nav-prev",onClick:re,title:"上一张 (←)"},t[16]||(t[16]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"15 18 9 12 15 6"})],-1)]))):A("",!0),s.value?(w(),C("button",{key:1,class:"nav-btn nav-next",onClick:de,title:"下一张 (→)"},t[17]||(t[17]=[e("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("polyline",{points:"9 18 15 12 9 6"})],-1)]))):A("",!0),e("button",{class:"close-btn",onClick:g,"aria-label":"Close modal"},t[18]||(t[18]=[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M18 6L6 18M6 6l12 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)]))]),u.value&&!I.value?(w(),C("div",tt,[t[19]||(t[19]=e("div",{class:"description-header"},[e("h2",{class:"description-title"},"图片描述")],-1)),e("div",{class:"description-content",ref_key:"contentRef",ref:Y},[e("div",{innerHTML:i.value,class:"markdown-body"},null,8,at)],512),e("div",ot,[oe(We,{issueTitle:`图片: ${x.image.alt||x.image.src}`},null,8,["issueTitle"])])])):A("",!0)],2)],544)):A("",!0)]))}},lt=pe(nt,[["__scopeId","data-v-9ebe1e8b"]]),st={__name:"WaterfallPage",setup(x){const $=m(null),H=m([]),F=m(null),M=m(""),z=m(!1),N=m(null),c=[".png",".jpg",".jpeg",".gif",".webp",".svg",".avif"];async function V(){const o="/Posts/WaterfallGraph",n=[];try{return await G(o,n),console.log("[WaterfallPage] Scanned files:",n),n}catch(l){return console.error("[WaterfallPage] Error scanning directory:",l),[]}}async function G(o,n){try{const l=Object.assign({"/public/Posts/WaterfallGraph/7ba7c1c378c78569279747e1c684a186.jpg":()=>S(()=>import("./chunk-7ba7c1c378c78569279747e1c684a186-CHPeMA2G.js"),[]).then(a=>a.default),"/public/Posts/WaterfallGraph/QQ图片20241210012107.jpg":()=>S(()=>import("./chunk-QQ图片20241210012107-BHzg_r5M.js"),[]).then(a=>a.default)});console.log("[WaterfallPage] Image modules found:",Object.keys(l));for(const a in l){const s=a.replace("/public",""),i=s.split("/").pop(),u=s.substring(0,s.lastIndexOf("/"));n.push({path:s,name:i,directory:u,fullPath:a})}console.log("[WaterfallPage] Processed files:",n)}catch(l){console.error(`[WaterfallPage] Error scanning ${o}:`,l)}}function Y(o){const n=o.filter(l=>{const a=l.name.lastIndexOf(".");if(a===-1)return console.log(`[WaterfallPage] File has no extension: ${l.name}`),!1;const s="."+l.name.substring(a+1).toLowerCase(),i=c.includes(s);return console.log(`[WaterfallPage] File: ${l.name}, Extension: ${s}, Supported: ${i}`),i});return console.log("[WaterfallPage] Filtered images:",n),n}async function W(o){console.log("[WaterfallPage] Loading metadata for",o.length,"files");const n=o.map(async s=>{try{const i=await p(s.path),u=s.name.lastIndexOf("."),v=u>0?s.name.substring(0,u):s.name,g=E(s.path),j=L(s.name)||new Date().toISOString(),y=await f(i),k={id:g,src:s.path,alt:v,title:v,width:i.naturalWidth,height:i.naturalHeight,aspectRatio:i.naturalWidth/i.naturalHeight,dominantColor:y,date:j,tags:[],mdPath:s.path.replace(/\.[^.]+$/,".md"),hasDescription:!1,directory:s.directory,fileName:s.name};return console.log("[WaterfallPage] Loaded metadata for:",s.name,k),k}catch(i){return console.error(`[WaterfallPage] Failed to load metadata for ${s.path}:`,i),null}}),a=(await Promise.all(n)).filter(s=>s!==null);return console.log("[WaterfallPage] Successfully loaded",a.length,"images"),a}function p(o){return new Promise((n,l)=>{const a=new Image,s=setTimeout(()=>{a.src="",l(new Error(`Timeout loading image: ${o}`))},1e4);a.onload=()=>{clearTimeout(s),console.log("[WaterfallPage] Image loaded successfully:",o),n(a)},a.onerror=i=>{clearTimeout(s),console.error("[WaterfallPage] Image load error:",o,i),l(new Error(`Failed to load image: ${o}`))},a.src=o})}async function f(o){try{const n=document.createElement("canvas"),l=n.getContext("2d",{willReadFrequently:!0}),a=100;n.width=a,n.height=a;const s=o.naturalWidth/2,i=o.naturalHeight/2,u=Math.max(0,s-a/2),v=Math.max(0,i-a/2),g=Math.min(a,o.naturalWidth),T=Math.min(a,o.naturalHeight);l.drawImage(o,u,v,g,T,0,0,a,a);const y=l.getImageData(0,0,a,a).data;let k=0,Q=0,Z=0,B=0;for(let P=0;P<y.length;P+=4){const te=y[P],le=y[P+1],se=y[P+2];y[P+3]>128&&(k+=te,Q+=le,Z+=se,B++)}const ne=Math.round(k/B),J=Math.round(Q/B),ee=Math.round(Z/B),U=D(ne,J,ee);return`hsl(${U.h}, ${U.s}%, ${U.l}%)`}catch(n){return console.error("[WaterfallPage] Failed to extract dominant color:",n),"hsl(250, 60%, 65%)"}}function D(o,n,l){o/=255,n/=255,l/=255;const a=Math.max(o,n,l),s=Math.min(o,n,l),i=a-s;let u=0,v=0,g=(a+s)/2;if(i!==0)switch(v=g>.5?i/(2-a-s):i/(a+s),a){case o:u=((n-l)/i+(n<l?6:0))/6;break;case n:u=((l-o)/i+2)/6;break;case l:u=((o-n)/i+4)/6;break}return u=Math.round(u*360),v=Math.round(v*100),g=Math.round(g*100),{h:u,s:v,l:g}}function E(o){let n=0;for(let l=0;l<o.length;l++){const a=o.charCodeAt(l);n=(n<<5)-n+a,n=n&n}return`img-${Math.abs(n)}`}function L(o){const n=[/(\d{4})-(\d{2})-(\d{2})/,/(\d{4})(\d{2})(\d{2})/,/(\d{4})_(\d{2})_(\d{2})/];for(const l of n){const a=o.match(l);if(a){const[,s,i,u]=a;try{const v=`${s}-${i}-${u}`,g=new Date(v);if(!isNaN(g.getTime()))return g.toISOString()}catch{console.warn("[WaterfallPage] Invalid date extracted from filename:",o)}}}return null}async function _(o){const n=o.map(async l=>{try{const a=await fetch(l.mdPath,{method:"HEAD"});l.hasDescription=a.ok}catch{l.hasDescription=!1}return l});return await Promise.all(n)}function q(o){return o.sort((n,l)=>{const a=new Date(n.date);return new Date(l.date)-a})}async function K(){try{const o=await V(),n=Y(o),l=await W(n),a=await _(l),s=q(a);H.value=s,console.log(`[WaterfallPage] Loaded ${s.length} images`)}catch(o){console.error("[WaterfallPage] Failed to load gallery images:",o),H.value=[]}}async function I(o,n){if(console.log("[WaterfallPage] Image clicked:",o,n),N.value=n,F.value=o,z.value=!0,o.hasDescription&&o.mdPath)try{console.log("[WaterfallPage] Loading description from:",o.mdPath);const l=await fetch(o.mdPath);if(l.ok){const a=await l.text();let s=a;try{s=De(a).body}catch{console.log("[WaterfallPage] No front-matter found, using raw content")}const i=he.render(s);M.value=i,console.log("[WaterfallPage] Description loaded and rendered successfully")}else console.warn("[WaterfallPage] Failed to load description:",l.status),M.value=""}catch(l){console.error("[WaterfallPage] Error loading description:",l),M.value=""}else console.log("[WaterfallPage] No description file for this image"),M.value=""}function O(){console.log("[WaterfallPage] Closing modal"),F.value=null,z.value=!1,M.value="",N.value=null,$.value&&$.value.resetAllCardStates&&$.value.resetAllCardStates()}return fe(()=>{K()}),(o,n)=>(w(),C(Pe,null,[oe(ye,{"show-tip-list":!1,"show-info-list":!1},{main:ve(()=>[oe(be,{ref_key:"waterfallPanelRef",ref:$,images:H.value,onImageClick:I},null,8,["images"])]),_:1}),F.value?(w(),ge(lt,{key:0,image:F.value,description:M.value,"trigger-card-rect":N.value,onClose:O},null,8,["image","description","trigger-card-rect"])):A("",!0)],64))}},pt=pe(st,[["__scopeId","data-v-5313561e"]]);export{pt as default};
