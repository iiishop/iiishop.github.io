async function y(e,o){const r=new TextEncoder().encode(e),c=await crypto.subtle.importKey("raw",r,"PBKDF2",!1,["deriveBits","deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:o,iterations:1e5,hash:"SHA-256"},c,{name:"AES-GCM",length:256},!1,["decrypt"])}function u(e){e=e.replace(/\s/g,"");try{const o=atob(e),t=new Uint8Array(o.length);for(let r=0;r<o.length;r++)t[r]=o.charCodeAt(r);return t}catch(o){console.warn("atob() 失败，尝试使用备用方法:",o);try{const t=`data:application/octet-stream;base64,${e}`,r=new XMLHttpRequest;r.open("GET",t,!1),r.overrideMimeType("text/plain; charset=x-user-defined"),r.send();const c=r.responseText,a=new Uint8Array(c.length);for(let n=0;n<c.length;n++)a[n]=c.charCodeAt(n)&255;return a}catch(t){return console.error("备用方法也失败:",t),p(e)}}}function p(e){const o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=new Uint8Array(256);for(let n=0;n<o.length;n++)t[o.charCodeAt(n)]=n;let r=e.length*.75;e[e.length-1]==="="&&(r--,e[e.length-2]==="="&&r--);const c=new Uint8Array(r);let a=0;for(let n=0;n<e.length;n+=4){const l=t[e.charCodeAt(n)],s=t[e.charCodeAt(n+1)],d=t[e.charCodeAt(n+2)],i=t[e.charCodeAt(n+3)];c[a++]=l<<2|s>>4,c[a++]=(s&15)<<4|d>>2,c[a++]=(d&3)<<6|i&63}return c}async function m(e,o){try{const t=/^---\n([\s\S]*?)\n---\n/,r=e.match(t);let c="",a=e;r&&(c=r[0],a=e.substring(r[0].length)),a=a.replace(`<!-- ENCRYPTED CONTENT -->
`,"").replace(/\s/g,"");const n=u(a);if(n.length<28)throw new Error("加密数据格式无效");const l=n.slice(0,16),s=n.slice(16,28),d=n.slice(28),i=await y(o,l),h=await crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:128},i,d),f=new TextDecoder("utf-8").decode(h);return c+f}catch(t){throw console.error("解密错误:",t),t.name==="OperationError"?new Error("密码错误或文件已损坏 (authentication failed)"):t}}function x(e,o,t){return t[o]?t[o].includes(e):!1}export{m as d,x as i};
